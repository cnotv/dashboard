name: Deploy to Kubernetes

on: [push]

env:
  K8S_NAME: ${{ github.event.pull_request.title || 'test-push' }}
  K8S_PATH: $GITHUB_WORKSPACE/k8s/test.yaml

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
   
    - name: Install doctl CLI
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_TOKEN }}

    # - name: Build Docker image
    #   run: |
    #     docker build -t rancher-dashboard .

    - name: Define env var values
      run: |
        echo "${{secrets.DIGITALOCEAN_CLUSTER}}" >> $GITHUB_WORKSPACE/k8s/cluster-config.yaml
        sed -e 's|<DIGITALOCEAN_DEPLOYMENT_NAME>|${{env.K8S_NAME}}|' $GITHUB_WORKSPACE/k8s/deployment.yaml

    - name: Delete existing Deployment from Rancher cluster
      run: |
        kubectl delete deployment ${{env.K8S_NAME}} --kubeconfig="${{env.K8S_PATH}}" 
        
    - name: Deploy to Rancher cluster
      run: |
        kubectl create deployment ${{env.K8S_NAME}} --image=rancher-dashboard --kubeconfig="${{env.K8S_PATH}}"
        # kubectl apply -f k8s/deployment.yaml --kubeconfig="${{env.K8S_PATH}}"

        